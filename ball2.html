<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ball</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
      }

      .container {
        position: relative;
        width: 420px;
        height: 420px;
        border-radius: 210px;
        margin: 200px auto;
      }

      .panel {
        position: absolute;
        bottom: -200px;
        left: 0;
        right: 0;
        text-align: center;
      }

      .ball {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 10px;
        background: red;
      }

      .circle {
        box-sizing: border-box;
        position: absolute;
        border: 1px solid rgb(47, 0, 255);
        border-radius: 250px;
        background: transparent;
      }

    </style>
  </head>

  <body>
    <div class="container">
      <div class="panel">
        <p>
          <button class="run">启动</button>
          <button class="stop">暂停</button>
        </p>

        <p>
          <button class="add">添加</button>
          <button class="del">删除</button>
        </p>
      </div>
    </div>

    <script>
      window.onload = function () {
        // 小球类
        var Ball = function (r, x, y, n, container) {
          this.r = r;
          this.x = x;
          this.y = y;
          this.n = n;

          this.container = container;

          var fragment = document.createDocumentFragment();

          // 插入圆
          this.circle = document.createElement('div');
          this.circle.classList.add('circle');
          this.circle.style.width = 2 * r + 'px';
          this.circle.style.height = 2 * r + 'px';
          this.circle.style.top = 210 - r + 'px';
          this.circle.style.left = 210 - r + 'px';
          fragment.appendChild(this.circle);

          // 插入小球
          this.el = document.createElement('div');
          this.el.classList.add('ball');
          this.el.style.top = y - r + 'px';
          this.el.style.left = x + 'px';
          fragment.appendChild(this.el);

          this.container.appendChild(fragment);
          // 角度矫正
          this.run.call(this, this.n);
        }

        // TODO: 优化动画性能
        Ball.prototype.run = function (n) {
          this.n = n;
          var a = Math.cos(this.n * Math.PI / 180) * this.r;
          var b = Math.sin(this.n * Math.PI / 180) * this.r;
          this.el.style.left = this.x + a + 'px';
          this.el.style.top = this.y + b + 'px';
        }

        Ball.prototype.remove = function () {
          this.container.removeChild(this.el);
          this.container.removeChild(this.circle);
        }

        // 小球组类
        var BallGroup = function (container) {
          this.group = [];
          this.n = 0;
          this.uid = 0;
          this.running = false;
          this.container = container || document.querySelector('body');
        }

        BallGroup.prototype.run = function () {
          if (this.group.length === 0 || this.timer) return;

          function _run() {
            this.n = ++this.n % 360;
            this.group.forEach(function (ball) {
              ball.run(this.n);
            }, this);
            this.timer = requestAnimationFrame(_run.bind(this));
          }

          _run.call(this);
        }

        BallGroup.prototype.stop = function () {
          if (this.timer) {
            window.cancelAnimationFrame(this.timer);
            this.timer = null;
          }
        }

        BallGroup.prototype.add = function (interval, x, y) {
          var ball = new Ball(group.uid * interval, x, y, this.n, this.container);
          this.uid++;
          this.group.push(ball);
        }

        BallGroup.prototype.remove = function () {
          if (this.group.length > 0) {
            this.uid--;
            this.group.pop().remove();
          }
        }

        var runBtn = document.querySelector('.run');
        var stopBtn = document.querySelector('.stop');
        var addBtn = document.querySelector('.add');
        var delBtn = document.querySelector('.del');

        var container = document.querySelector('.container');

        var group = new BallGroup(container);

        runBtn.addEventListener('click', function () {
          group.run();
        });

        stopBtn.addEventListener('click', function () {
          group.stop();
        });

        addBtn.addEventListener('click', function () {
          if (group.uid > 8) return;
          group.add(30, 200, 200);
        });

        delBtn.addEventListener('click', function () {
          group.remove();
        });
      }

    </script>

  </body>

</html>
